name: NGA User Post Monitor

on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Run monitor script
        env:
          NGA_UID: ${{ secrets.NGA_UID }}
          SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }}
        run: |
          python - <<EOF
          import requests
          from bs4 import BeautifulSoup
          import os
          import time

          # 读取环境变量
          nga_uid = os.getenv("NGA_UID")
          send_key = os.getenv("SERVERCHAN_KEY")

          # 已推送的帖子ID（本次运行临时存储）
          posted_tids = set()

          # NGA请求头
          headers = {
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          }

          # 抓取用户主页
          def fetch_user_posts():
              url = f"https://bbs.nga.cn/nuke.php?uid={nga_uid}"
              try:
                  resp = requests.get(url, headers=headers, timeout=10)
                  resp.encoding = "utf-8"
                  soup = BeautifulSoup(resp.text, "html.parser")
                  username = soup.select_one(".usertop .username")
                  username = username.text.strip() if username else "未知用户"
                  posts = soup.select(".topic_row")
                  post_list = []
                  for post in posts:
                      tid = post.get("data-tid")
                      title_elem = post.select_one(".topic_title")
                      if tid and title_elem:
                          title = title_elem.text.strip()
                          content_elem = post.select_one(".topic_content")
                          content = content_elem.text.strip()[:200] if content_elem else ""
                          post_list.append({"tid": tid, "title": title, "content": content})
                  return username, post_list
              except Exception as e:
                  print(f"抓取失败：{str(e)}")
                  return "未知用户", []

          # 推送至微信（单行格式，避免YAML语法错误）
          def push_to_wechat(username, title, tid, content):
              if not send_key:
                  print("未配置Server酱SendKey")
                  return
              push_url = f"https://sctapi.ftqq.com/{send_key}.send"
              # 关键修复：把多行字符串改成单行，用\n替代换行
              desp_content = "**发帖人**：{} \n**帖子标题**：{} \n**帖子链接**：https://bbs.nga.cn/read.php?tid={} \n**发布时间**：{} \n\n内容预览：{}...".format(username, title, tid, time.strftime('%Y-%m-%d %H:%M:%S'), content)
              data = {
                  "title": f"【NGA】{username}发布新帖",
                  "desp": desp_content
              }
              try:
                  resp = requests.post(push_url, data=data, timeout=10)
                  print(f"推送结果：{resp.text}")
              except Exception as e:
                  print(f"推送失败：{str(e)}")

          # 主逻辑
          def main():
              username, posts = fetch_user_posts()
              new_posts = [p for p in posts if p["tid"] not in posted_tids]
              if new_posts:
                  print(f"发现{len(new_posts)}条新帖")
                  for post in new_posts:
                      push_to_wechat(username, post["title"], post["tid"], post["content"])
                      posted_tids.add(post["tid"])
              else:
                  print("暂无新帖")

          if __name__ == "__main__":
              main()
          EOF
