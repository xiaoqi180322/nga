name: NGA帖子抓取与推送（北京时间）
on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'  # 每5分钟执行（UTC时间）

jobs:
  crawl_nga:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 设置时区为北京时间
      - name: Set timezone to Asia/Shanghai
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          date

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 pytz

      - name: Run NGA crawler
        env:
          NGA_COOKIE: ${{ secrets.NGA_COOKIE }}
          SERVERCHAN_SENDKEY: ${{ secrets.SERVERCHAN_SENDKEY }}
        run: |
          python nga_crawler.py

      - name: Commit history file
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add ${{ env.HISTORY_FILE }}
          if git diff --quiet --exit-code ${{ env.HISTORY_FILE }}; then
            echo "历史文件无变更，无需提交"
          else
            git commit -m "Update NGA post history: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "历史文件已提交"
          fi
        env:
          HISTORY_FILE: nga_post_history.json
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print execution log
        if: always()
        run: |
          echo "任务执行完成，查看上方日志确认结果"
